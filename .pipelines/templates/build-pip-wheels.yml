parameters:
- name: march
  type: string
  default: armv8-a
- name: buildType
  type: string
  default: Debug
- name: buildTesting
  type: string
  default: OFF
- name: enableCoverage
  type: string
  default: OFF
- name: agentBuildDirectory
  type: string
  default: $(Agent.BuildDirectory)
- name: dockerImage
  type: string
  default: ubuntu:22.04
- name: imageTag
  type: string
  default: linux/amd64
- name: pythonVersion
  type: string
  default: 3.11
- name: cmakeVersion
  type: string
  default: 3.28.3
- name: hdf5Version
  type: string
  default: 1.13.0
- name: blisVersion
  type: string
  default: 2.0
- name: libflameVersion
  type: string
  default: 5.2.0
- name: pyenvVersion
  type: string
  default: 2.6.15
- name: macBuild
  type: string
  default: OFF
steps:
- checkout: self
  persistCredentials: true
  path: qdk-chemistry

- task: PipAuthenticate@1
  displayName: Pip Authenticate
  inputs:
    artifactFeeds: ""

- ${{ if eq(parameters.macBuild, 'OFF') }}:
  - script: |
      echo "Running pip wheel build (Linux)..."
      docker run --rm \
        --platform ${{ parameters.imageTag }} \
        -v ${{ parameters.agentBuildDirectory }}:/workspace:rshared \
        -e QDK_UARCH=${{ parameters.march }} \
        -w /workspace/qdk-chemistry \
        ${{ parameters.dockerImage }} \
      bash .pipelines/pip-scripts/build-pip-wheels.sh ${{ parameters.march }} \
                                                      ${{ parameters.pythonVersion }} \
                                                      ${{ parameters.buildType }} \
                                                      ${{ parameters.buildTesting }} \
                                                      ${{ parameters.enableCoverage }} \
                                                      ${{ parameters.cmakeVersion }} \
                                                      ${{ parameters.hdf5Version }} \
                                                      ${{ parameters.blisVersion }} \
                                                      ${{ parameters.libflameVersion }} \
                                                      ${{ parameters.pyenvVersion }} \
                                                      ${{ parameters.macBuild }}
    displayName: Build wheel (Linux)
    retryCountOnTaskFailure: 4

- ${{ if eq(parameters.macBuild, 'ON') }}:
  - script: |
      echo "Running pip wheel build (native)..."
      cd ${{ parameters.agentBuildDirectory }}/qdk-chemistry
      bash .pipelines/pip-scripts/build-pip-wheels.sh ${{ parameters.march }} \
                                                      ${{ parameters.pythonVersion }} \
                                                      ${{ parameters.buildType }} \
                                                      ${{ parameters.buildTesting }} \
                                                      ${{ parameters.enableCoverage }} \
                                                      ${{ parameters.cmakeVersion }} \
                                                      ${{ parameters.hdf5Version }} \
                                                      ${{ parameters.blisVersion }} \
                                                      ${{ parameters.libflameVersion }} \
                                                      ${{ parameters.pyenvVersion }} \
                                                      ${{ parameters.macBuild }}
    displayName: Build wheel (macOS native)
    retryCountOnTaskFailure: 4
