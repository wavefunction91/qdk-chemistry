# Build steps template for QDK/Chemistry
# Currently used in build.yaml and coverage.yaml workflows
parameters:
- name: march
  type: string
  default: x86-64-v3
- name: buildType
  type: string
  default: Debug
- name: enableCoverage
  type: string
  default: OFF
  values:
  - ON
  - OFF
- name: buildTesting
  type: string
  default: OFF
  values:
  - ON
  - OFF
- name: agentBuildDirectory
  type: string
  default: $(Agent.BuildDirectory)
- name: systemDefaultWorkingDirectory
  type: string
  default: $(System.DefaultWorkingDirectory)
- name: artifactProject
  type: string
  default: ""
- name: artifactFeed
  type: string
  default: ""

steps:
# Checkout all required repositories
- checkout: self
  persistCredentials: true
  path: qdk-chemistry

- task: PipAuthenticate@1
  displayName: Pip Authenticate
  inputs:
    artifactFeeds: AzureQuantum/AQE

- script: |
    sudo apt-get update
    sudo apt-get install -y \
      libeigen3-dev \
      nlohmann-json3-dev \
      libhdf5-dev \
      libopenblas-dev \
      libboost-all-dev \
      libgtest-dev \
      libgmock-dev \
      libfmt-dev \
      libecpint-dev \
      ninja-build \
      gcovr \
      patchelf
    # Verify default GCC version (should be compatible with manylinux_2_31)
    gcc --version
    g++ --version
  displayName: Install Package Manager Dependencies

- script: |
    cd ${{ parameters.agentBuildDirectory }}/qdk-chemistry
    CMAKE_FLAGS="-DBUILD_TESTING=${{ parameters.buildTesting }} -DCMAKE_BUILD_TYPE=${{ parameters.buildType }} -DQDK_CHEMISTRY_ENABLE_COVERAGE=${{ parameters.buildTesting}} -DQDK_UARCH=${{ parameters.march }} -DCMAKE_INSTALL_PREFIX=${{ parameters.agentBuildDirectory }}/qdk-chemistry/install"
    cmake -S cpp -B build_cpp -G Ninja $CMAKE_FLAGS
    cmake --build build_cpp --target all
  displayName: Compile C++

- script: |
    cmake --build ${{ parameters.agentBuildDirectory }}/qdk-chemistry/build_cpp --target install
  displayName: Install C++ Libraries

- script: |
    cmake -S ${{ parameters.agentBuildDirectory }}/qdk-chemistry/cpp/examples -B ${{ parameters.agentBuildDirectory }}/qdk-chemistry/build_example -DCMAKE_PREFIX_PATH=${{ parameters.agentBuildDirectory }}/qdk-chemistry/install
    cmake --build ${{ parameters.agentBuildDirectory }}/qdk-chemistry/build_example --target all
    echo "C++ Example Compiled with Pre-Installed QDK/Chemistry-C++ Libraries!"
  displayName: Test Installed C++ CMake Discovery

- script: |
    cd ${{ parameters.agentBuildDirectory }}/qdk-chemistry/python
    export QDK_COVERAGE_BUILD=ON
    export CMAKE_BUILD_TYPE=Debug
    echo "Building Python package with coverage configuration..."
    # Install in development mode to preserve source code links for coverage
    pip install .[all] --verbose
  displayName: Install Python Package with Coverage
  condition: or(eq('${{ parameters.enableCoverage }}', 'true'), eq('${{ parameters.enableCoverage }}', 'ON'))
  env:
    QDK_UARCH: ${{ parameters.march }}
    QDK_CHEMISTRY_COVERAGE_BUILD: 1
